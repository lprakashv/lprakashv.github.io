<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Circuit Breaker pattern in Scala - LPRAKASHV CODE BYTES</title><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta name=viewport content="width=device-width,initial-scale=1"><script async src="https://www.googletagmanager.com/gtag/js?id=G-DNE09NG226"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-DNE09NG226")</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3468549466738898" crossorigin=anonymous></script><meta name=description content="Circuit breaker pattern is a common microservice resiliency pattern to make system responsive after series of failures and have a fallback mechanism.
[NOTE] Spoiler — This would be a simple implementation and the Scala code would be stateful and have side-effects.
The Need Doing a remote call or executing a task which is outside the domain boundary of the system is very common in modern applications. Especially in microservice world, we are bound to make calls to other microservices."><meta property="og:image" content><meta property="og:title" content="Circuit Breaker pattern in Scala"><meta property="og:description" content="Circuit breaker pattern is a common microservice resiliency pattern to make system responsive after series of failures and have a fallback mechanism.
[NOTE] Spoiler — This would be a simple implementation and the Scala code would be stateful and have side-effects.
The Need Doing a remote call or executing a task which is outside the domain boundary of the system is very common in modern applications. Especially in microservice world, we are bound to make calls to other microservices."><meta property="og:type" content="article"><meta property="og:url" content="https://www.lprakashv.com/posts/2020-03-28_circuit-breaker-pattern-in-scala/"><meta property="og:image" content="https://www.lprakashv.com/posts/2020-03-28_circuit-breaker-pattern-in-scala/images/1.jpeg"><meta property="og:image" content="https://www.lprakashv.com/posts/2020-03-28_circuit-breaker-pattern-in-scala/images/2.png"><meta property="og:image" content="https://www.lprakashv.com/posts/2020-03-28_circuit-breaker-pattern-in-scala/images/3.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-28T20:30:28+00:00"><meta property="article:modified_time" content="2022-08-13T01:14:50+05:30"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.lprakashv.com/posts/2020-03-28_circuit-breaker-pattern-in-scala/images/1.jpeg"><meta name=twitter:title content="Circuit Breaker pattern in Scala"><meta name=twitter:description content="Circuit breaker pattern is a common microservice resiliency pattern to make system responsive after series of failures and have a fallback mechanism.
[NOTE] Spoiler — This would be a simple implementation and the Scala code would be stateful and have side-effects.
The Need Doing a remote call or executing a task which is outside the domain boundary of the system is very common in modern applications. Especially in microservice world, we are bound to make calls to other microservices."><script src=https://www.lprakashv.com/js/feather.min.js></script>
<link href=https://www.lprakashv.com/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://www.lprakashv.com/css/main.42a94afe1d883ff4fcef4d850a21c8e0c6903e7b33798d5ca18916cbd645a78a.css></head><body><div class=content-side><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3468549466738898" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block data-ad-client=ca-pub-3468549466738898 data-ad-slot=6861065745 data-ad-format=auto data-full-width-responsive=true></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div class=content><header><div class=main><div style=display:flex;flex-direction:row><img src="../../LPRAKASHV CODE BYTES-logos_transparent.png" style=border-color:#fff;border-radius:10px;width:150px><div style=margin:auto><a href=https://www.lprakashv.com/ style=font-size:30px;font-weight:700>LPRAKASHV CODE BYTES</a></div></div></div><nav><a href=../../>Home</a>
<a href=../../posts>All posts</a>
<a href=../../about>About</a>
<a href=../../tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>Circuit Breaker pattern in Scala</h1><div class=meta>Posted on Mar 28, 2020</div></div><section class=body><p><img src=../../posts/2020-03-28_circuit-breaker-pattern-in-scala/images/1.jpeg#layoutTextWidth alt=image></p><p><a href=https://martinfowler.com/bliki/CircuitBreaker.html><strong>Circuit breaker pattern</strong></a> is a common microservice resiliency pattern to make system responsive after series of failures and have a fallback mechanism.</p><p>[NOTE] Spoiler — This would be a simple implementation and the Scala code would be stateful and have side-effects.</p><h3 id=the-need>The Need</h3><p>Doing a remote call or executing a task which is outside the domain boundary of the system is very common in modern applications. Especially in microservice world, we are bound to make calls to other microservices.</p><p>In such scenarios, we need to consider eventual failures. If some failures are too continuous and consistent in nature, they can hog too much of the system resources resulting into failures. We can avoid such cases using the circuit-breaker pattern.</p><h3 id=the-concept>The Concept</h3><p><img src=../../posts/2020-03-28_circuit-breaker-pattern-in-scala/images/2.png#layoutTextWidth alt=image>
courtesy: <a href=https://martinfowler.com/bliki/CircuitBreaker.html>https://martinfowler.com/bliki/CircuitBreaker.html</a></p><p>The concept is simple, the circuit represents the connection between the caller and the callee. It can only have 3 states: <strong>closed</strong>, <strong>open</strong> and <strong>half-open</strong>. The system starts with the “closed” circuit initially.</p><p>We monitor the consecutive (or within a time window) failures from the callee and when the failures exceed a threshold we trip the circuit to “open” and all the further calls from the caller won’t reach the callee and rather caller is returned with a default fallback result.</p><blockquote><p>— can be implemented using a <strong>failure result counter.</strong></p></blockquote><p>We also keep monitoring the time since opening the circuit and when a certain timeout is reached, we put the circuit to “half-open” meaning, only one ‘probe’ call will pass through and its result will determine if the circuit will be closed or opened based on its success or failure.</p><blockquote><p>— can be implemented using a <strong>background timer.</strong></p></blockquote><h3 id=implementation>Implementation</h3><p><strong>CircuitState</strong> — a trait extended by possible states</p><script type=application/javascript src=https://gist.github.com/lprakashv/3b9aceb424a00f7b62289db568e8bdfe.js></script><p><strong>CircuitResult[T]</strong> — a trait extended by Success and Failure results of the Circuit with success return type T.</p><script type=application/javascript src=https://gist.github.com/lprakashv/9457e7f0670f05bad084f60802789e0d.js></script><p><strong>Circuit[R]</strong> — a class denoting a circuit where the call returns the result of type Future[R], future denoting an async call.</p><script type=application/javascript src=https://gist.github.com/lprakashv/f91ade5061ab15a70a08ff34065f61e1.js></script><p>States of the Circuit</p><script type=application/javascript src=https://gist.github.com/lprakashv/875480ef20e6e1191fcce3405e7bba90.js></script><p>Transition of states</p><script type=application/javascript src=https://gist.github.com/lprakashv/1e06d37addcca8af52968e33e89dfa86.js></script><p><strong>Main block execution handler</strong> — It acts as a router and invokes other handlers based on the Circuit’s state. After state transition, the thread request may come back here to be routed again based on the updated state.</p><script type=application/javascript src=https://gist.github.com/lprakashv/5d73aed0e919a43bf6a2e3620e8ddf05.js></script><p><strong>Handling failure response from the Callee</strong> —</p><script type=application/javascript src=https://gist.github.com/lprakashv/3d55a8db8e545be12459e24ca8cf7942.js></script><p><strong>Handling closed circuit</strong>— Executing the provided block of code and yield a success or failure as the result asynchronously, while maintaining/updating the count of consecutive failures.</p><script type=application/javascript src=https://gist.github.com/lprakashv/ff0aecba16bf2b41730e56a9f9f205dd.js></script><p><strong>Handling Half-Open Circuit</strong> —</p><script type=application/javascript src=https://gist.github.com/lprakashv/e83dc09914510936594920693b89a61f.js></script><p><strong>Handling open circuit</strong>— return the successful future with CircuitSuccess wrapping the default value.</p><script type=application/javascript src=https://gist.github.com/lprakashv/4bf1d46eb8a5ea9a38290c970d86d185.js></script><p><strong>Half-Opener Background Timer</strong> — Will trip the circuit to half-open after timeout reached since opening the circuit.</p><script type=application/javascript src=https://gist.github.com/lprakashv/fc539d500f17fe3e2f82094a358d4a0f.js></script><p><strong>CircuitImplicits</strong> — Implicits making the use of our Circuit class a breeze!</p><script type=application/javascript src=https://gist.github.com/lprakashv/1dfe69c3d933da42de263444b7667247.js></script><p>We can now do something like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#080;font-weight:700>implicit</span> <span style=color:#080;font-weight:700>val</span> sampleCircuit<span style=color:#080;font-weight:700>:</span> <span style=color:#339;font-weight:700>Circuit</span><span style=color:#333>[</span><span style=color:#339;font-weight:700>Int</span><span style=color:#333>]</span> <span style=color:#080;font-weight:700>=</span> <span style=color:#080;font-weight:700>new</span> <span style=color:#b06;font-weight:700>Circuit</span><span style=color:#333>[</span><span style=color:#339;font-weight:700>Int</span><span style=color:#333>](</span>
</span></span><span style=display:flex><span>    <span style=background-color:#fff0f0>&#34;sample-circuit&#34;</span><span style=color:#333>,</span>
</span></span><span style=display:flex><span>    <span style=color:#00d;font-weight:700>5</span><span style=color:#333>,</span>                <span style=color:#888>// max allowed consecutive closed failures
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#60e;font-weight:700>5.</span>seconds<span style=color:#333>,</span>        <span style=color:#888>// half-opener timeout
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#00d;font-weight:700>1</span><span style=color:#333>,</span>                <span style=color:#888>// max allowed consecutive half-open failures
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#333>-</span><span style=color:#00d;font-weight:700>1</span><span style=color:#333>,</span>               <span style=color:#888>// invalid success result
</span></span></span><span style=display:flex><span><span style=color:#888></span>    <span style=color:#b06;font-weight:700>_println</span>
</span></span><span style=display:flex><span><span style=color:#080;font-weight:700>_</span><span style=color:#333>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888>//this will use the above created circuit to execute
</span></span></span><span style=display:flex><span><span style=color:#888></span><span style=color:#b06;font-weight:700>Future</span><span style=color:#333>.</span>successful<span style=color:#333>(</span><span style=color:#00d;font-weight:700>2</span> <span style=color:#333>+</span> <span style=color:#00d;font-weight:700>2</span><span style=color:#333>).</span>executeAsync
</span></span></code></pre></div><p><strong>Testing it out</strong> — You can find the test cases <a href=https://github.com/lprakashv/scala-utils/blob/master/src/test/scala/com/lprakashv/resiliency/CircuitTest.scala>here</a>.</p><p><img src=../../posts/2020-03-28_circuit-breaker-pattern-in-scala/images/3.png#layoutTextWidth alt=image></p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=../../tags/scala>scala</a></li><li><a href=../../tags/circuit-breaker-pattern>circuit breaker pattern</a></li><li><a href=../../tags/microservice-patterns>microservice patterns</a></li></ul></nav></div><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script");t.src="https://lprakashv-tech-blog.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></article></main><footer><div style=display:flex><a class=soc href=https://www.linkedin.com/in/lprakashv/ title=Linkedin><i data-feather=linkedin></i></a>
<a class=border></a><a class=soc href=https://github.com/lprakashv title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/lprakashv/ title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href="https://stackoverflow.com/users/4066802/lprakashv?tab=profile" title=stackoverflow><i data-feather=stackoverflow></i></a>
<a class=border></a></div><div class=footer-info>2022 © Lalit Prakash Vatsal |</div></footer><script>feather.replace()</script></div><div class=content-side><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3468549466738898" crossorigin=anonymous></script>
<ins class=adsbygoogle style=display:block data-ad-client=ca-pub-3468549466738898 data-ad-slot=6861065745 data-ad-format=auto data-full-width-responsive=true></ins>
<script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></body></html>